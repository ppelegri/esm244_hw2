---
title: 'Task 2: Parameter Estimation (PELEGRI)'
author: "Patrick Pelegri-O'Day"
date: "1/31/2022"
output:
  html_document: 
    theme: flatly
    highlight: pygments
code_folding: hide
---

### Overview
[insert overview text: provide purpose and method of the analysis, then describe the dataset.]

For task 2, you will use non linear least squares to estimate parameters of a length to weight model for lizard populations in New Mexico. 

**Data Source:** Lightfoot, D. and W.G. Whitford. 2020. Lizard pitfall trap data from 11 NPP study locations at the Jornada Basin LTER site, 1989-2006 ver 37. Environmental Data Initiative. https://doi.org/10.6073/pasta/4a6e258fb49c31e222ecbbcfd128967f

```{r setup, include=TRUE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(here)
library(purrr)
library(tidyverse)
library(Metrics)
library(patchwork)
library(modelr)
```

```{r read in data}
lizards_raw <- read_csv(here("data", "lizard.csv"))
```


### Analysis

Our conceptual model is:
\begin{equation}
W=a(SVL)^b
\end{equation}
We want to estimate a and b. To do so, we take the natural log of both sides.
ln(weight) = ln(a(length)$^b$). This is equal to
ln(weight) = b * ln(a) + b * ln(length)

We can use OLS to get an estimate for *a* and *b*.
*b* will simply be the estimated coefficient for ln(length) once we run OLS.
*b* * ln(*a*) will be equal to the intercept estimate from our OLS model.
Thus, the estimate for *a* will be equal to $e^β/b$, where β is the y-intercept estimate

```{r log transform the data}
lizards <- lizards_raw %>% 
  mutate(log_length = log(SV_length)) %>% 
  mutate(log_weight = log(weight))
```

```{r create nls model}

# Create initial OLS model using log variables in order to generate guess of NLS model parameters
my_guess_model <- lm(log_weight ~ log_length, data = lizards)
guess_coeffs <- coef(my_guess_model)

# Define weight to length model for lizards
calc_weight <- function(a, SVL, b){
 W = a*SVL^b
return(W)
}

lizards_nls = nls(weight ~ calc_weight(a, SV_length, b),
                  data = lizards,
                  start = list(a = exp(guess_coeffs[1]/guess_coeffs[2]), 
                               b = guess_coeffs[2]), 
                  trace = TRUE)

```

```{r nls general model table}
# Create tidy version of lizards_nls, then create table
# All p-values were extremely small; the ifelse renames them for readability
lizards_nls_tidy <- tidy(lizards_nls)

lizards_nls_tidy$p.value <- ifelse(lizards_nls_tidy$p.value < .001, paste("<0.001"))

lizareds_nls_tidy %>%
  select(-statistic) %>% 
  kable(col.names = c("Parameter", "Estimate", 
                      "Standard Error", "P Value"), 3) %>% 
  kable_styling(bootstrap_options = "striped", 
                position = "left", full_width = FALSE)

```


### Step 2
Present your fitted model on a plot with female and male lizards separated by color. You should include the nls model in `kable` output of the html.

```{r}
# Create vector of predicted values for weight
lizards_pred_v <- predict(lizards_nls)

# Append original lizards df with lizards_pred_v
lizards_pred_df <- lizards %>% 
  mutate(pred_weight = lizards_pred_v)
```


**Customize colors**
```{r}
# Graph predicted weight vs actual weight
ggplot(data = lizards_pred_df, 
       aes(x = SV_length, y = lizards_pred_v)) +
  geom_point(aes(x = SV_length, y = weight, color = sex),
             size = 1.5) +
  scale_color_manual(values = c('tan1', 'sienna3')) +
  geom_line(color = 'thistle4', size = 1) +
  theme_minimal() +
  theme(legend.title = element_blank(),
        legend.position = "bottom") +
  labs(x = "Snout to Vent Length (mm)",
       y = "Weight (g)")
```

##### **Figure 1:** *This graph shows the actual weight of lizards separated by sex and a fitted non-linear least squares model (the purple line) that predicts wight from snout to vent length.* 

This graph shows that the fitted model predicts lizard weight from snout to vent length acceptably. 

### Step 3

```{r}
# Filter dataset for male Western Whiptail lizard
lizards_mWW_df <- lizards_raw %>% 
  filter(sex == "M", spp == "CNTI") %>%  
  mutate(log_length = log(SV_length)) %>% 
  mutate(log_weight = log(weight))

# Create modified OLS model using log variables in order to generate guess of NLS model parameters
lm_guess_mWW <- lm(log_weight ~ log_length, data = lizards)
guess_coeffs_mWW <- coef(lm_guess_mWW)

# Redefine lizards_nls function for new subset df
lizards_mWW_nls = nls(weight ~ calc_weight(a, SV_length, b),
                  data = lizards_mWW_df,
                  start = list(a = exp(guess_coeffs_mWW[1]/guess_coeffs_mWW[2]), 
                               b = guess_coeffs_mWW[2]), 
                  trace = TRUE)

# Create vector of predicted values for weight
lizards_mWW_pred_v <- predict(lizards_mWW_nls)

# Append original lizards_mWW_df with lizards_pred_v
lizards_mWW_pred_df <- lizards_mWW_df %>% 
  mutate(pred_weight_mWW = lizards_mWW_pred_v)
```

Compare the two models
```{r}
lizards_compare_df <- lizards_pred_df %>% 
  filter(spp == "CNTI", sex == 'M') %>% 
  mutate(pred_weight_gen = pred_weight) %>% 
  mutate(pred_weight_mWW = lizards_mWW_pred_v)
```

**Customize colors**
```{r graphically compare two models}
# Graph predictions from general model vs mWW-specific model
ggplot(lizards_compare_df) +
  geom_point(aes(x = SV_length, y = weight), 
             color = "sienna3",
             size = 1.5) +
  geom_line(aes(x = SV_length, y = pred_weight_gen,
                color = "General Model"), size = 1) +
  geom_line(aes(x = SV_length, y = pred_weight_mWW,
                color = "Whiptail Model"), size = 1) +
  scale_colour_manual(values =
                      c("General Model" = "thistle4",
                        "Whiptail Model" = "darkgoldenrod2")) +
  theme_minimal() +
  theme(legend.title = element_blank(),
        legend.position = "bottom") +
  labs(x = "Snout to Vent Length (mm)",
       y = "Weight (g)")

```

```{r compare rmse}
lizards_nls_gen_rmse <- rmse(model = lizards_nls, data = lizards_compare_df)
lizards_nls_mWW_rmse <- rmse(model = lizards_mWW_nls, data = lizards_compare_df)
```


