---
title: 'Task 2: Parameter Estimation (PELEGRI)'
author: "Patrick Pelegri-O'Day"
date: "1/31/2022"
output:
  prettydoc::html_pretty:
    theme: architect
    highlight: github
code_folding: hide
---

### Overview
[insert overview text: provide purpose and method of the analysis, then describe the dataset.]

For task 2, you will use non linear least squares to estimate parameters of a length to weight model for lizard populations in New Mexico. 

**Data Source:** Lightfoot, D. and W.G. Whitford. 2020. Lizard pitfall trap data from 11 NPP study locations at the Jornada Basin LTER site, 1989-2006 ver 37. Environmental Data Initiative. https://doi.org/10.6073/pasta/4a6e258fb49c31e222ecbbcfd128967f

```{r setup, include=TRUE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(here)
library(purrr)
library(tidyverse)
library(Metrics)
library(patchwork)
library(modelr)
```

```{r read in data}
lizards_raw <- read_csv(here("data", "lizard.csv"))
```


### Analysis

Our conceptual model is Weight = a(length)$^b$
We want to estimate a and b. To do so, we take the natural log of both sides.
ln(weight) = ln(a(length)$^b$). This is equal to
ln(weight) = b * ln(a) + b * ln(length)

We can use OLS to get an estimate for *a* and *b*.
*b* will simply be the estimated coefficient for ln(length) once we run OLS.
*b* * ln(*a*) will be equal to the intercept estimate from our OLS model.
Thus, the estimate for *a* will be equal to $e^β/b$, where β is the y-intercept estimate

```{r log transform the data}
lizards <- lizards_raw %>% 
  mutate(log_length = log(SV_length)) %>% 
  mutate(log_weight = log(weight))
```

```{r create nls model}

# Create initial OLS model using log variables in order to generate guess of NLS model parameters
my_guess_model <- lm(log_weight ~ log_length, data = lizards)
guess_coeffs <- coef(my_guess_model)

# Define weight to length model for lizards
calc_weight <- function(a, SVL, b){
 W = a*SVL^b
return(W)
}

lizards_nls = nls(weight ~ calc_weight(a, SV_length, b),
                  data = lizards,
                  start = list(a = exp(guess_coeffs[1]/guess_coeffs[2]), 
                               b = guess_coeffs[2]), 
                  trace = TRUE)

kable(lizards_nls,
      caption = "Table 1. NLS model") %>% 
  kable_styling(full_width = FALSE)

```

### Step 2
Present your fitted model on a plot with female and male lizards separated by color. You should include the nls model in `kable` output of the html.

```{r}
# Create vector of predicted values for weight
lizards_pred_v <- predict(lizards_nls)

# Append original lizards df with lizards_pred_v
lizards_pred_df <- lizards %>% 
  mutate(pred_weight = lizards_pred_v)

# Graph predicted weight vs actual weight
ggplot(lizards_pred_df) +
  geom_jitter(aes(x = weight, y = pred_weight, color = sex)) + 
  geom_abline(aes(x = weight, y = pred_weight), 
              intercept = 0,
              slope = 1,
              color = "cornsilk4",
              size = 1.5) +
  labs(x = "Weight", y = "Predicted weight")

  

### Create kable output
```

### Step 3

```{r}
# Filter dataset for male Western Whiptail lizard
lizards_mWW_df <- lizards_raw %>% 
  filter(sex == "M", spp == "CNTI") %>%  
  mutate(log_length = log(SV_length)) %>% 
  mutate(log_weight = log(weight))

# Create modified OLS model using log variables in order to generate guess of NLS model parameters
lm_guess_mWW <- lm(log_weight ~ log_length, data = lizards)
guess_coeffs_mWW <- coef(lm_guess_mWW)

# Redefine lizards_nls function for new subset df
lizards_mWW_nls = nls(weight ~ calc_weight(a, SV_length, b),
                  data = lizards_mWW_df,
                  start = list(a = exp(guess_coeffs_mWW[1]/guess_coeffs_mWW[2]), 
                               b = guess_coeffs_mWW[2]), 
                  trace = TRUE)

# Create vector of predicted values for weight
lizards_mWW_pred_v <- predict(lizards_mWW_nls)

# Append original lizards_mWW_df with lizards_pred_v
lizards_mWW_pred_df <- lizards_mWW_df %>% 
  mutate(pred_weight_mWW = lizards_mWW_pred_v)

# # Graph predicted weight vs actual weight
# ggplot(lizards_mWW_pred_df) +
#   geom_jitter(aes(x = weight, y = pred_weight, color = sex)) + 
#   geom_abline(aes(x = weight, y = pred_weight), 
#               intercept = 0,
#               slope = 1,
#               color = "cornsilk4",
#               size = 1.5) +
#   labs(x = "Weight", y = "Predicted weight")
```

Compare the two models
```{r}
lizards_compare_df <- lizards_pred_df %>% 
  filter(spp == "CNTI", sex == 'M') %>% 
  mutate(pred_weight_gen = pred_weight) %>% 
  mutate(pred_weight_mWW = lizards_mWW_pred_v)

# Graph predictions from general model vs mWW-specific model
ggplot(lizards_compare_df) +
  geom_jitter(aes(x = weight, y = pred_weight_mWW), color = "darkslateblue") +
  geom_jitter(aes(x = weight, y = pred_weight_gen),color = "gold3") +
  geom_jitter(aes(x = weight, y = weight),color = "black") +
  labs(x = "Weight", y = "Predicted weight")

lizards_nls_gen_rmse <- rmse(model = lizards_nls, data = lizards_compare_df)
lizards_nls_mWW_rmse <- rmse(model = lizards_mWW_nls, data = lizards_compare_df)

```

